!function(){"use strict";var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};function t(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}function n(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{d(r.next(e))}catch(e){i(e)}}function a(e){try{d(r.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}d((r=r.apply(e,t||[])).next())}))}function r(e,t){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}var o=function(){function e(){var e=this;this.listeners=[];var t,n,r,o,i=(t=function(){e.updateHistory()},n=0,o=0,function(){var e=this,i=arguments,s=function(){o=null,r||t.apply(e,i)},a=r&&!o;clearTimeout(o),o=setTimeout(s,n),a&&t.apply(e,i)});this.monkeyPatchHistory(),window.addEventListener("locationchange",i,!1),window.addEventListener("hashchange",i,!1),window.addEventListener("popstate",i,!1),window.addEventListener("pushState",i,!1),window.addEventListener("replaceState",i,!1)}return e.prototype.addListener=function(e){this.listeners.push(e)},e.prototype.destroy=function(){},e.prototype.monkeyPatchHistory=function(){var e=function(e){var t=history[e];return function(){var n=t.apply(this,arguments),r=new Event(e);return r.arguments=arguments,window.dispatchEvent(r),n}};history.pushState=e("pushState"),history.replaceState=e("replaceState")},e.prototype.updateHistory=function(){for(var e,t=window.location.href,n=null===(e=null===window||void 0===window?void 0:window.history)||void 0===e?void 0:e.state,r=0,o=this.listeners;r<o.length;r++){(0,o[r])({url:t,state:n})}},e}(),i=function(){function e(){var e=this;this.listeners=[],document.querySelector("title")?this.setup():setTimeout((function(){return e.setup()}),0)}return e.prototype.setup=function(){var e=this;this.observer=new MutationObserver((function(){return e.updateTitle()}));var t=document.querySelector("title");t&&this.observer.observe(t,{subtree:!0,characterData:!0,childList:!0})},e.prototype.addListener=function(e){this.listeners.push(e)},e.prototype.destroy=function(){this.observer&&this.observer.disconnect()},e.prototype.updateTitle=function(){for(var e=this.getTitle(),t=0,n=this.listeners;t<n.length;t++){(0,n[t])(e)}},e.prototype.getTitle=function(){return document.title},e}(),s=function(){function e(){this.requestHandlers=new Map,this.ready=!1}return e.prototype.addRequestHandler=function(e,t){this.requestHandlers.set(e,t)},e.prototype.download=function(e){return n(this,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,this.send("download",e)];case 1:return[2,t.sent()]}}))}))},e.prototype.setup=function(e){return n(this,void 0,void 0,(function(){var t;return r(this,(function(n){switch(n.label){case 0:if(this.ready)throw new Error("LayersSDK already set up!");return this.options=e.options,[4,this.send("setup",e)];case 1:if(!(t=n.sent()).success)throw new Error("Handshake failed!");return this.ready=!0,[2,{bridgeConnected:!0,platform:this.getPlatform(),payload:t.payload}]}}))}))},e}();function a(e){for(var t=0,n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n),t|=0}return t.toString(16)}var d=/^LAYERS:(-?[0-9a-f]+):(.+)$/,u=new(function(){function e(){}return e.prototype.serialize=function(e){var t=JSON.stringify(e);return"LAYERS:"+a(t)+":"+t},e.prototype.deserialize=function(e){var t=d.exec(e);if(!t)throw new Error("Malformed message");var n=t[1],r=t[2];if(a(r)!==n)throw new Error("Corrupted message");return JSON.parse(r)},e}()),c=function(e){function o(t){var n=e.call(this)||this;return n.pendingMessages={},n.targetWindow=t.targetWindow,n.targetOrigin=t.targetOrigin,n.version="1.0.4",n._bindedEventHandler=n._eventHandler.bind(n),window.addEventListener("message",n._bindedEventHandler,!1),n}return t(o,e),o.prototype.getPlatform=function(){return"iframe"},o.prototype.setup=function(t){var o,i;return n(this,void 0,void 0,(function(){var n,s=this;return r(this,(function(r){switch(r.label){case 0:if(window===this.targetWindow)throw new Error("Target must be a different Window");return[4,e.prototype.setup.call(this,t)];case 1:return n=r.sent(),this.layersPortalLocation=null===(o=n.payload)||void 0===o?void 0:o.layersPortalLocation,this.layersPortalInnerLocationBase=null===(i=n.payload)||void 0===i?void 0:i.layersPortalInnerLocationBase,window.addEventListener("focus",(function(){return s.setLocalStorage()})),this.setLocalStorage(),[2,n]}}))}))},o.prototype.setLocalStorage=function(){this.layersPortalLocation&&(localStorage.__layers_portal_location__=this.layersPortalLocation),this.layersPortalInnerLocationBase&&(localStorage.__layers_portal_inner_location_base__=this.layersPortalInnerLocationBase)},o.prototype.destroy=function(){this._bindedEventHandler&&(window.removeEventListener("message",this._bindedEventHandler,!1),this._bindedEventHandler=null),this.ready=!1},o.prototype.send=function(e,t,n){var r=this;return void 0===n&&(n=3e4),new Promise((function(o,i){var s=~~(Math.random()*(1<<30)),a=setTimeout((function(){i(new Error("Message "+s+" timed out!"))}),n);r.pendingMessages[s]={resolve:o,reject:i,timeoutId:a};var d={id:s,method:e,payload:t,version:r.version,type:"request"};try{r._postMessage(r.targetWindow,d,r.targetOrigin)}catch(e){return i(e)}}))},o.prototype.dispatch=function(e,t){if(this.requestHandlers.has(e))return this.requestHandlers.get(e)(t)},o.prototype._postMessage=function(e,t,n){var r=u.serialize(t);e.postMessage(r,n)},o.prototype._eventHandler=function(e){if(e.source===this.targetWindow){var t;try{t=u.deserialize(e.data)}catch(e){return}if(t.id)switch(t.type){case"response":return void this._handleResponseMessage(t);case"error":return void this._handleErrorMessage(t);case"request":return void this._handleRequestMessage(t,e.source);default:this.dispatch("error",new Error('Message received with unknown type "'+t.type+'"!'))}else this.dispatch("error",new Error("Message received without id!"))}},o.prototype._handleResponseMessage=function(e){var t=e.id,n=e.payload;if(t in this.pendingMessages){var r=this.pendingMessages[t],o=r.resolve,i=r.timeoutId;clearTimeout(i),delete this.pendingMessages[t],o(n)}},o.prototype._handleErrorMessage=function(e){var t=e.id,n=new Error(e.payload);if(t in this.pendingMessages){var r=this.pendingMessages[t],o=r.reject,i=r.timeoutId;clearTimeout(i),delete this.pendingMessages[t],o(n)}},o.prototype._handleRequestMessage=function(e,t){var n=this,r=e.id,o=e.method,i=e.payload,s=this.dispatch(o,i);Promise.resolve(s).then((function(e){n._postMessage(t,{id:r,payload:e,version:n.version,type:"response"},"*")})).catch((function(e){n._postMessage(t,{id:r,payload:e.message,version:n.version,type:"error"},"*")}))},o}(s);var l=function(e){function o(){return null!==e&&e.apply(this,arguments)||this}return t(o,e),o.prototype.setup=function(e){return n(this,void 0,void 0,(function(){var t,n,o;return r(this,(function(r){return e.options.insidePortalOnly?(t=localStorage.__layers_portal_location__,n=localStorage.__layers_portal_inner_location_base__,t?window.location.href.startsWith(n)?(o=window.location.href.substring(n.length),window.location.href=""+t+o):window.location.href=t:window.location.href="https://id.layers.digital/",[2]):(this.ready=!1,[2,{bridgeConnected:!1}])}))}))},o.prototype.getPlatform=function(){return null},o.prototype.send=function(e,t,o){return n(this,void 0,void 0,(function(){return r(this,(function(t){throw new Error("App has no bridge to Layers "+e)}))}))},o.prototype.download=function(e){return n(this,void 0,void 0,(function(){var t,n,o;return r(this,(function(r){return t=e.url,n=e.filename,(o=document.createElement("a")).download=n,o.href=t,document.body.appendChild(o),o.click(),document.body.removeChild(o),[2]}))}))},o}(s),p=function(e){function n(){var t=e.call(this)||this;return t.pendingMessages={},t.version="1.0.4",t._bindedEventHandler=t._eventHandler.bind(t),window.addEventListener("layers:android",t._bindedEventHandler,!1),t}return t(n,e),n.prototype.getPlatform=function(){return"android"},n.prototype.destroy=function(){this._bindedEventHandler&&(window.removeEventListener("layers:android",this._bindedEventHandler,!1),this._bindedEventHandler=null),this.ready=!1},n.prototype.send=function(e,t,n){var r=this;return void 0===n&&(n=3e4),new Promise((function(o,i){var s=~~(Math.random()*(1<<30)),a=setTimeout((function(){i(new Error("Message "+s+" timed out!"))}),n);r.pendingMessages[s]={resolve:o,reject:i,timeoutId:a};var d={layers:!0,id:s,method:e,payload:t,version:r.version,type:"request",success:!0};try{r._postMessage(d)}catch(e){return i(e)}}))},n.prototype.dispatch=function(e,t){if(this.requestHandlers.has(e))return this.requestHandlers.get(e)(t)},n.prototype._postMessage=function(e){window.LayersAndroidBridge.send(JSON.stringify(e))},n.prototype._eventHandler=function(e){var t=e.detail;if(t.id)switch(t.type){case"response":return void this._handleResponseMessage(t);case"request":return void this._handleRequestMessage(t);default:this.dispatch("error",new Error('Message received with unknown type "'+t.type+'"!'))}else this.dispatch("error",new Error("Message received without id!"))},n.prototype._handleResponseMessage=function(e){var t=e.id,n=e.payload;if(t in this.pendingMessages){var r=this.pendingMessages[t],o=r.timeoutId;if(clearTimeout(o),delete this.pendingMessages[t],e.success)(0,r.resolve)(n);else(0,r.reject)(n)}},n.prototype._handleRequestMessage=function(e){var t=this,n=e.id,r=e.method,o=e.payload,i=this.dispatch(r,o);Promise.resolve(i).then((function(e){t._postMessage({layers:!0,id:n,payload:e,version:t.version,type:"response",success:!0})})).catch((function(e){t._postMessage({layers:!0,id:n,payload:e.message,version:t.version,type:"error",success:!1})}))},n}(s);var h=function(e){function n(){var t=e.call(this)||this;return t.pendingMessages={},t.version="1.0.4",t._bindedEventHandler=t._eventHandler.bind(t),window.addEventListener("layers:ios",t._bindedEventHandler,!1),t}return t(n,e),n.prototype.getPlatform=function(){return"ios"},n.prototype.destroy=function(){this._bindedEventHandler&&(window.removeEventListener("layers:ios",this._bindedEventHandler,!1),this._bindedEventHandler=null),this.ready=!1},n.prototype.send=function(e,t,n){var r=this;return void 0===n&&(n=3e4),new Promise((function(o,i){var s=~~(Math.random()*(1<<30)),a=setTimeout((function(){i(new Error("Message "+s+" timed out!"))}),n);r.pendingMessages[s]={resolve:o,reject:i,timeoutId:a};var d={layers:!0,id:s,method:e,payload:t,version:r.version,type:"request",success:!0};try{r._postMessage(d)}catch(e){return i(e)}}))},n.prototype.dispatch=function(e,t){if(this.requestHandlers.has(e))return this.requestHandlers.get(e)(t)},n.prototype._postMessage=function(e){window.webkit.messageHandlers.LayersIosBridge.postMessage(e)},n.prototype._eventHandler=function(e){var t=e.detail;if(t.id)switch(t.type){case"response":return void this._handleResponseMessage(t);case"request":return void this._handleRequestMessage(t);default:this.dispatch("error",new Error('Message received with unknown type "'+t.type+'"!'))}else this.dispatch("error",new Error("Message received without id!"))},n.prototype._handleResponseMessage=function(e){var t=e.id,n=e.payload;if(t in this.pendingMessages){var r=this.pendingMessages[t],o=r.timeoutId;if(clearTimeout(o),delete this.pendingMessages[t],e.success)(0,r.resolve)(n);else(0,r.reject)(n)}},n.prototype._handleRequestMessage=function(e){var t=this,n=e.id,r=e.method,o=e.payload,i=this.dispatch(r,o);Promise.resolve(i).then((function(e){t._postMessage({layers:!0,id:n,payload:e,version:t.version,type:"response",success:!0})})).catch((function(e){t._postMessage({layers:!0,id:n,payload:e.message,version:t.version,type:"error",success:!1})}))},n}(s);window.LayersPortal=function(){var e,t,s,a=this,d=document.createElement("div"),u=new o,f=new i,v={setup:function(e){return n(this,void 0,void 0,(function(){var t,n=this;return r(this,(function(r){switch(r.label){case 0:if(this.ready)throw new Error("LayersPortalSDK already set up!");return this.options=e,(s=function(){var e,t;return window.LayersAndroidBridge?new p:(null===(t=null===(e=window.webkit)||void 0===e?void 0:e.messageHandlers)||void 0===t?void 0:t.LayersIosBridge)?new h:window.frameElement||window.parent!==window?new c({targetOrigin:"*",targetWindow:window.parent}):new l}()).addRequestHandler("ping",(function(){return"pong"})),t=this,[4,s.setup({options:e,url:window.location.href,state:null===history||void 0===history?void 0:history.state,title:f.getTitle()})];case 1:return t.setupResult=r.sent(),this.ready=!0,d.dispatchEvent(new CustomEvent("ready",{detail:this.setupResult})),this.setupResult.bridgeConnected?(this.connected=!0,d.dispatchEvent(new CustomEvent("connected",{detail:this.setupResult})),u.addListener((function(e){n("update",e)})),f.addListener((function(e){n("update",{title:e})})),u.updateHistory(),f.updateTitle(),[2]):[2]}}))}))},ping:function(){return s.send("ping")},getAccountToken:function(){return s.send("getAccountToken")},getCommunity:function(){return s.send("getCommunity")},ready:function(){return s.send("ready")},update:function(e){return s.send("update",e)},download:function(e){return n(this,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,s.download(e)];case 1:return[2,t.sent()]}}))}))},close:function(e){try{s.send("close",e)}catch(e){}try{window.close()}catch(e){}}},y=function(e,t){return n(a,void 0,void 0,(function(){var n;return r(this,(function(r){switch(r.label){case 0:if(!(n=v[e]))throw new Error("Method "+e+" not found.");return[4,n.bind(y)(t)];case 1:return[2,r.sent()]}}))}))};y.ready=!1,y.connected=!1,y.setupResult=null,y.platform=this,y.on=function(e,t){d.addEventListener(e,(function(e){t(e.detail)}))};var w=null===(e=window.LayersPortal)||void 0===e?void 0:e.q;if(w)for(var g=0,_=w;g<_.length;g++){var m=_[g],M=m[0],b=m[1],E=m[2],L=m[3];y(E,L).then(M).catch(b)}var H=null===(t=window.LayersPortal)||void 0===t?void 0:t.eh;if(H)for(var P in H)for(var q=0,S=H[P];q<S.length;q++){var R=S[q];y.on(P,R)}return y}(),window.LayersPortalOptions&&window.LayersPortal("setup",window.LayersPortalOptions)}();
//# sourceMappingURL=LayersPortal.js.map
